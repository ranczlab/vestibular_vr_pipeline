# Saccade Detection Documentation

## Overview

This document describes the saccade detection algorithm used in the vestibular VR pipeline. The detection method identifies rapid eye movements (saccades) from time-series position data generated by SLEAP-based eye tracking.

---

## Detection Pipeline

The saccade detection process consists of three main stages:

### 1. Preprocessing

**Position Smoothing**
- The raw position data (`Ellipse.Center.X`) is smoothed using a **rolling median filter** with a centered window
- This reduces noise and tracking artifacts while preserving sharp transitions
- Formula: `X_smooth[t] = median(X[t-window//2 : t+window//2])`

**Velocity Computation**
- Instantaneous velocity is calculated from the smoothed position data
- Formula: `vel_x_smooth[t] = (X_smooth[t] - X_smooth[t-1]) / dt[t]`
- Velocity is computed using finite differences with variable time steps

### 2. Adaptive Threshold Detection

**Threshold Calculation**
- The detection uses an **adaptive statistical threshold** based on the velocity distribution
- Threshold formula: `vel_thresh = mean(|velocity|) + k × std(|velocity|)`
- This adapts to the noise level and movement characteristics of each recording
- Separate thresholds are calculated for upward and downward saccades (same magnitude, different sign)

**Peak Detection**
- Uses `scipy.signal.find_peaks` to identify velocity peaks that exceed the threshold
- **Upward saccades**: Positive velocity peaks
- **Downward saccades**: Negative velocity peaks (detected by inverting the signal)
- Peak detection parameters:
  - **Height**: Must exceed `vel_thresh`
  - **Distance**: Minimum separation between peaks = `fps × refractory_period` (in samples)
  - **Width**: Minimum peak width = `saccade_peak_width` (in samples)

**Onset and Offset Detection**
For each detected peak, the algorithm determines the saccade boundaries:

1. **Onset (start)**:
   - Starts at the peak position
   - Moves **backward** in time
   - Stops when `|velocity| < vel_thresh × onset_offset_fraction`
   - Uses a fraction of the threshold for sensitivity to catch early movement

2. **Offset (end)**:
   - Starts at the peak position
   - Moves **forward** in time
   - Stops when `|velocity| < vel_thresh` (full threshold)
   - Uses the full threshold to accurately capture the end of rapid movement
   - Special handling for low sampling rates where velocity may only exceed threshold briefly

**Saccade Metrics**
For each detected saccade, the algorithm calculates:
- Peak time and velocity
- Onset time (start_time)
- Offset time (end_time)
- Duration = offset_time - onset_time
- Amplitude = |end_position - start_position|

### 3. Post-Processing

**Peri-Saccade Segment Extraction**
- Extracts time windows around each detected saccade
- Window: `n_before` points before threshold crossing + `n_after` points after
- Time is normalized relative to threshold crossing (`Time_rel_threshold`)
- Segments with unreasonable time ranges or data gaps are excluded

**Baselining**
- Each segment is baselined to remove pre-saccade position offsets
- Baseline window: last `baseline_n_points` points before threshold crossing
- Baselined position = `X_smooth - baseline_mean`
- Centers all saccades at baseline = 0 for comparison

**Outlier Filtering**
- Filters out outlier saccades using IQR (Interquartile Range) method
- Outlier criteria (3×IQR):
  - Amplitude outliers
  - Maximum absolute position outliers
  - Maximum absolute velocity outliers
- Outliers are excluded from analysis but preserved for inspection

---

## Input Parameters

### Core Detection Parameters

| Parameter | Default | Unit | Description |
|-----------|---------|------|-------------|
| `k` | 4-5 | standard deviations | Multiplier for adaptive threshold. Controls sensitivity: higher = more selective (fewer detections), lower = more sensitive (more detections) |
| `refractory_period` | 0.1 | seconds | Minimum time between saccades. Prevents detection of multiple peaks within the same saccade. Typical saccade duration is 20-200ms, so 100ms prevents double-counting |
| `onset_offset_fraction` | 0.2 | fraction (0-1) | Fraction of peak velocity threshold used for onset detection. Lower values catch earlier movement, higher values miss slow initiation |
| `saccade_peak_width` | 1 | frames | Minimum peak width in samples for `find_peaks`. Filters out very brief spikes that may be noise. Higher values require broader peaks |

### Preprocessing Parameters

| Parameter | Default | Unit | Description |
|-----------|---------|------|-------------|
| `saccade_smoothing_window` | 5 | frames | Rolling median window size for position smoothing. Larger values = more smoothing (may blur fast movements), smaller values = less smoothing (more noise) |

### Post-Processing Parameters

| Parameter | Default | Unit | Description |
|-----------|---------|------|-------------|
| `n_before` | 10 | points | Number of points before threshold crossing to extract. Defines pre-saccade baseline window. Independent of FPS |
| `n_after` | 30 | points | Number of points after threshold crossing to extract. Defines post-saccade analysis window. Independent of FPS |
| `baseline_n_points` | 5 | points | Number of points before threshold crossing used for baseline calculation. Should be ≤ `n_before` |

### Eye-Specific Parameters

- `k1`: Threshold multiplier for VideoData1 (typically Left eye)
- `k2`: Threshold multiplier for VideoData2 (typically Right eye)
- Different eyes may have different noise levels or movement characteristics, requiring separate thresholds

---

## Fine-Tuning Guide

### Under-Detection (Missing Saccades)

If the algorithm is missing real saccades:

1. **Decrease `k` (threshold multiplier)**
   - Current: `k=4` or `k=5`
   - Try: `k=3` or `k=3.5`
   - Effect: Lowers the velocity threshold, making detection more sensitive
   - Warning: May increase false positives

2. **Decrease `saccade_peak_width`**
   - Current: `peak_width=1`
   - Try: `peak_width=1` (already minimum)
   - Note: This is already at minimum; reducing further won't help

3. **Decrease `refractory_period`** (if saccades are very close together)
   - Current: `refractory_period=0.1` seconds
   - Try: `refractory_period=0.05` seconds
   - Effect: Allows detection of saccades closer together
   - Warning: May cause double-counting of single saccades

4. **Check smoothing**
   - Current: `saccade_smoothing_window=5`
   - Try: `saccade_smoothing_window=3`
   - Effect: Less smoothing preserves sharp velocity peaks
   - Warning: May increase noise sensitivity

5. **Check data quality**
   - Verify that blinks are properly excluded (marked as NaN)
   - Check that position data has sufficient temporal resolution
   - Ensure no large gaps in data that could break velocity computation

### Over-Detection (False Positives)

If the algorithm is detecting noise or non-saccade movements:

1. **Increase `k` (threshold multiplier)**
   - Current: `k=4` or `k=5`
   - Try: `k=6` or `k=7`
   - Effect: Raises the velocity threshold, making detection more selective
   - Warning: May miss smaller/weaker saccades

2. **Increase `saccade_peak_width`**
   - Current: `peak_width=1`
   - Try: `peak_width=2` or `peak_width=3`
   - Effect: Requires broader peaks, filtering out brief spikes
   - Warning: May miss very brief saccades

3. **Increase `refractory_period`**
   - Current: `refractory_period=0.1` seconds
   - Try: `refractory_period=0.15` or `refractory_period=0.2` seconds
   - Effect: Prevents detection of closely spaced peaks
   - Warning: May miss rapid saccadic sequences

4. **Increase smoothing**
   - Current: `saccade_smoothing_window=5`
   - Try: `saccade_smoothing_window=7` or `saccade_smoothing_window=9`
   - Effect: More smoothing reduces noise spikes
   - Warning: May blur fast movements and reduce peak heights

5. **Adjust `onset_offset_fraction`**
   - Current: `onset_offset_fraction=0.2`
   - Try: `onset_offset_fraction=0.3` or `0.4`
   - Effect: Requires higher velocity for onset detection, reducing detection of slow drifts
   - Warning: May shorten detected saccade durations

6. **Review outlier filtering**
   - Check if outlier filtering is removing valid saccades
   - Examine `upward_outliers_meta` and `downward_outliers_meta` to see what's being filtered
   - Adjust outlier filtering thresholds if needed (in `filter_outlier_saccades`)

### Parameter Interaction Considerations

- **`k` vs `saccade_peak_width`**: 
  - `k` controls the velocity threshold (how high peaks must be)
  - `peak_width` controls peak breadth (how wide peaks must be)
  - Adjust both together for optimal detection

- **`refractory_period` vs actual saccade rate**:
  - If saccades occur >10 times per second, consider reducing `refractory_period`
  - If saccades are isolated (>200ms apart), current `refractory_period=0.1s` is appropriate

- **Smoothing vs sensitivity**:
  - More smoothing reduces noise but may also reduce peak heights
  - If you increase smoothing, you may need to decrease `k` to compensate

- **`onset_offset_fraction` vs duration**:
  - Lower values extend detected duration (catch slow initiation/termination)
  - Higher values shorten detected duration (only fast phases)
  - Typical saccades have brief high-velocity phases, so 0.2 is usually appropriate

### Diagnostic Steps

1. **Visualize detection results**:
   - Use `plot_saccade_detection_QC = True` to see detected saccades overlaid on velocity traces
   - Check if detected peaks align with visual inspection

2. **Review detection statistics**:
   - Check mean velocity, duration, and amplitude of detected saccades
   - Compare with expected values from literature (typical saccades: 20-200ms duration, 10-100 px amplitude)

3. **Examine threshold values**:
   - Print statements show the calculated `vel_thresh`
   - Compare with typical velocity ranges in your data
   - If threshold seems too high/low, adjust `k`

4. **Check excluded segments**:
   - Review `all_excluded` to see if valid saccades are being excluded due to data gaps
   - Consider adjusting `n_before`/`n_after` if segments are frequently excluded

5. **Compare eyes**:
   - If one eye has different detection rates, adjust `k1` vs `k2` separately
   - Different cameras or tracking quality may require different thresholds

---

## Algorithm Limitations

1. **Fixed adaptive threshold**: The threshold is calculated once from the entire recording. If noise levels change over time, this may not be optimal.

2. **Peak-based detection**: Requires clear velocity peaks. Very slow movements or gradual accelerations may not be detected.

3. **Symmetric threshold**: Uses the same threshold magnitude for upward and downward saccades. If eye movement characteristics differ by direction, this may not be optimal.

4. **Refractory period**: Assumes saccades cannot occur within the refractory period. Very rapid saccadic sequences may be missed.

5. **Segment extraction**: Requires sufficient data points before/after threshold crossing. Edge cases and data gaps may exclude valid saccades.

---

## Example Parameter Sets

### Conservative (Fewer False Positives)
```python
k = 6
refractory_period = 0.15
saccade_peak_width = 2
saccade_smoothing_window = 7
onset_offset_fraction = 0.3
```

### Sensitive (More Detections)
```python
k = 3
refractory_period = 0.05
saccade_peak_width = 1
saccade_smoothing_window = 3
onset_offset_fraction = 0.15
```

### Balanced (Default)
```python
k = 4-5
refractory_period = 0.1
saccade_peak_width = 1
saccade_smoothing_window = 5
onset_offset_fraction = 0.2
```

---

## References

- Typical saccade characteristics: 20-200ms duration, peak velocities 30-900 deg/s
- Refractory period: Typically 100-200ms between saccades
- Velocity-based detection is standard in eye movement research

---

## Version History

- Initial documentation: Based on `saccade_processing.py` and `SANDBOX_1_1_Loading_+_Saccade_detection.py`

